name: Release Menubar App

on:
  push:
    tags:
      - "menubar-v*"

jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build ccw CLI (universal binary)
        run: |
          GOOS=darwin GOARCH=arm64 go build -o ccw-arm64 .
          GOOS=darwin GOARCH=amd64 go build -o ccw-amd64 .
          lipo -create -output ccw ccw-arm64 ccw-amd64

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.0"

      - name: Build Menubar App
        run: |
          xcodebuild -workspace CCWMenubar.xcworkspace \
            -scheme CCWMenubar \
            -configuration Release \
            -archivePath build/CCWMenubar.xcarchive \
            archive
          xcodebuild -exportArchive \
            -archivePath build/CCWMenubar.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist ExportOptions.plist

      - name: Code Sign (if certificates available)
        if: env.APPLE_CERTIFICATE != ''
        run: |
          codesign --force --sign "$DEVELOPER_ID" \
            build/export/CCWMenubar.app/Contents/MacOS/ccw
          codesign --force --options runtime \
            --entitlements Config/CCWMenubar.entitlements \
            --sign "$DEVELOPER_ID" \
            build/export/CCWMenubar.app

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "CCW Menubar" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 425 178 \
            CCWMenubar.dmg \
            build/export/CCWMenubar.app

      - name: Notarize and Staple (if certificates available)
        if: env.APPLE_CERTIFICATE != ''
        run: |
          xcrun notarytool submit CCWMenubar.dmg --wait \
            --key "$NOTARYTOOL_KEY" --key-id "$NOTARYTOOL_KEY_ID" --issuer "$NOTARYTOOL_ISSUER"
          xcrun stapler staple CCWMenubar.dmg

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          files: CCWMenubar.dmg
          generate_release_notes: true

      - name: Update Homebrew Tap
        if: env.TAP_GITHUB_TOKEN != ''
        run: |
          VERSION="${GITHUB_REF_NAME#menubar-v}"
          SHA="$(shasum -a 256 CCWMenubar.dmg | awk '{print $1}')"
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/justanotheratom/homebrew-ccw.git"
          cd homebrew-ccw
          mkdir -p Casks
          cat > Casks/ccw-menubar.rb <<EOF
          cask "ccw-menubar" do
            version "${VERSION}"
            sha256 "${SHA}"

            url "https://github.com/justanotheratom/ccw/releases/download/menubar-v#{version}/CCWMenubar.dmg"
            name "CCW Menubar"
            desc "Menubar app for Claude Code Workspace manager"
            homepage "https://github.com/justanotheratom/ccw"

            app "CCWMenubar.app"

            zap trash: [
              "~/.ccw",
            ]
          end
          EOF
          if git diff --quiet -- Casks/ccw-menubar.rb; then
            echo "Cask unchanged"
            exit 0
          fi
          git add Casks/ccw-menubar.rb
          git -c user.name="github-actions[bot]" -c user.email="github-actions[bot]@users.noreply.github.com" commit -m "Update ccw-menubar cask to ${VERSION}"
          git push

env:
  APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
  DEVELOPER_ID: ${{ secrets.DEVELOPER_ID }}
  NOTARYTOOL_KEY: ${{ secrets.NOTARYTOOL_KEY }}
  NOTARYTOOL_KEY_ID: ${{ secrets.NOTARYTOOL_KEY_ID }}
  NOTARYTOOL_ISSUER: ${{ secrets.NOTARYTOOL_ISSUER }}
  TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
